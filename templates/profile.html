{% extends 'boilerplates/base_navbar.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Profile{% endblock %}

{% block content %}
<div class="content-wrapper">
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="row">
            <div class="col-lg-4">
              <div class="border-bottom text-center pb-4">
                {% if user.image %}
                <img class="rounded-circle account-img" src="{{ user.image.url }}" width="100" height="100">
                {% else %}
                <img class="rounded-circle account-img" src="{% static 'images/default.jpg' %}" width="100"
                  height="100">
                {% endif %}
                <div class="mb-3">
                  <h3>{{ user.first_name }} {{ user.last_name}}</h3>
                  <div class="d-flex align-items-center justify-content-center">
                    <h5 class="mb-0 me-2 text-muted">Andrew ID: {{ user.andrew_id }}</h5>
                    <div class="br-wrapper br-theme-css-stars"><select id="profile-rating" name="rating"
                        autocomplete="off" style="display: none;">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                      </select>
                      <div class="br-widget"><a href="#" data-rating-value="1" data-rating-text="1"
                          class="br-selected br-current"></a><a href="#" data-rating-value="2"
                          data-rating-text="2"></a><a href="#" data-rating-value="3" data-rating-text="3"></a><a
                          href="#" data-rating-value="4" data-rating-text="4"></a><a href="#" data-rating-value="5"
                          data-rating-text="5"></a></div>
                    </div>
                  </div>
                </div>
                {% comment %} <p class="w-75 mx-auto mb-3">This is my Bio. </p>
                <div class="d-flex justify-content-center">
                  <button class="btn btn-success">Message</button>
                </div> {% endcomment %}
              </div>
              <div class="border-bottom py-4" >
                <p>Unlocked Badges</p>
                <ul class="list-group list-group-flush">
                  <li class="list-group-item" style="display: none" id = "Veteran Participant">
                    <div class="card text-center">
                      <div class="card-header">
                        Badge
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Veteran Participant</h5>
                  
                        <button type="button" class="btn btn-danger rounded-pill" id = "Veteran Participant badge"><img src = "../static/images/badges/evaluater.svg" width="35" 
                          height= "auto">Veteran Participant</button>
                         
                      </div>
                      <div class="card-footer text-muted">
                      </div>
                    </div>
                  </li>

                  <li class="list-group-item" style="display: none" id = "Seasoned Evaluator">
                    <div class="card text-center">
                      <div class="card-header">
                        Badge
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Seasoned Evaluator</h5>
                      
                        <button type="button" class="btn btn-success rounded-pill" id = "Seasoned Evaluator badge"><img src = "../static/images/badges/season-evaluater.svg" width="35" 
                          height= "auto">Seasoned Evaluator</button>
                         
                      </div>
                      <div class="card-footer text-muted">
                      </div>
                    </div>
                  </li>



                  <li class="list-group-item" style="display: none" id = "Detailed Evaluator">
                    <div class="card text-center">
                      <div class="card-header">
                        Badge
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Detailed Evaluator</h5>
            
                        <button type="button" class="btn btn-info rounded-pill" id = "Detailed Evaluator badge"><img src = "../static/images/badges/detailed-evaluater.svg" width="35" 
                          height= "auto">Detailed Evaluator</button>
                         
                      </div>
                      <div class="card-footer text-muted">
                      </div>
                    </div>
                  </li>
                
                  
                  <li class="list-group-item" style="display: none" id = "Seasoned Presenter">
                    <div class="card text-center">
                      <div class="card-header">
                        Badge
                      </div>
                      <div class="card-body">
                        <h5 class="card-title">Seasoned Presenter</h5>
                  
                        <button type="button" class="btn btn-warning rounded-pill" id = "Seasoned Presenter Badge"><img src = "../static/images/badges/open-minded-orange.svg" width="35" 
                          height= "auto">Seasoned Presenter</button>
                         
                      </div>
                      <div class="card-footer text-muted">
                      </div>
                    </div>
                  </li>
                </ul>
          
              </div>
               <div class="border-bottom py-4" id = "Badges in Progress" >
                <p>Badges in Progress</p>
                
              </div>


             
              <div class="py-4">
                {% comment %} <p class="clearfix">
                  <span class="float-left">
                    Active:
                  </span>
                  <span class="float-right text-muted">
                    {{ user.is_active }}
                  </span>
                </p> {% endcomment %}
              </div>
              {% comment %} <button class="btn btn-primary btn-block mb-2">Preview</button> {% endcomment %}
            </div>
            <div class="col-lg-8">
              <div class="d-block d-md-flex justify-content-between mt-4 mt-md-0">
                <div class="text-center mt-4 mt-md-0">
                  <h4 class="card-title"><button onclick="backButton()" class="btn btn-outline-primary">Edit Profile</button></h4>
                </div>
              </div>
              <div class="content-section">
                <div class="table-responsive">
                  <table class="table">
                    <thead>
                      <tr>
                        {% comment %} <th>Profile</th>
                        <th>VatNo.</th> {% endcomment %}
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td>Email address: </td>
                        <td>{{ user.email }} </td>
                      </tr>
                      <tr>
                        <td>First Name: </td>
                        <td>{{ user.first_name }}</td>
                      </tr>
                      <tr>
                        <td>Last Name: </td>
                        <td>{{ user.last_name}}</td>
                      </tr>
                      <tr>
                        <td>Date joined: </td>
                        <td>{{ user.date_joined }}</td>
                      </tr>
                      <tr>
                        <td>Staff: </td>
                        <td>{% if user.is_staff == True %}
                          Yes
                          {% else %}
                          No
                          {% endif %}</td>
                      </tr>

                    </tbody>
                  </table>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% endblock content %}

{% block js %}
<script>
  function backButton() {
    currentUrl = window.location.href;
    window.location.href = currentUrl.replace('/profile/', '/profile_edit/');
  }

</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
<script>

$(document).ready(function () {
  let badges = [];
  let adjaxCall
        ajaxCall = $.ajax({
          async: false,
          url: `/api/rules/progress`,
          type: 'GET',
          success: function (data) {
            badges.push(data);
          },
        });
  if(badges && badges.length > 0){

    // Traversing all the unlocked badges
    for(let i = 0; i < badges[0].length; i += 1){

      let conditonCount = badges[0][i].conditions.length; 
      let currConditionCount = 0; 
      //console.log("conditonCount:\n" + conditonCount);
      
      if(conditonCount > 0){

        for(let j = 0; j < conditonCount; j += 1){
            let currCount = badges[0][i].conditions[j].Curr_count;
            let unlockCount = badges[0][i].conditions[j].Unlock_count;
            if(currCount >= unlockCount){
              currConditionCount += 1;  
            
            }
        }
        // If the condition matched, show the badges 
        if(currConditionCount >= conditonCount){
          let badgeDOM = document.getElementById(badges[0][i].rule_name);
          
          if(!badgeDOM){
            continue; 
          }
          badgeDOM.style.display = "block"; 
     
        }
        }
    }
  }
   
        
   let html = `<div class="card text-center">
                      <div class="card-header">
                        Progressing Badges
                      </div>
                      <div class="card-body">`;
    for(let i = 0; i < badges[0].length; i += 1){
      let conditonCount = badges[0][i].conditions.length; 
      let currConditionCount = 0; 
      if(currConditionCount >= conditonCount){
        continue;
      }else{
           html += `<p>${badges[0][i].rule_name}</p>  <ul class="list-group list-group-flush">`;
          for(let j = 0; j < conditonCount; j += 1){
            let currCount = badges[0][i].conditions[j].Curr_count;
            let unlockCount = badges[0][i].conditions[j].Unlock_count;
            const progress = currCount > unlockCount ? 100 : (currCount / unlockCount) * 100; 
             
             html += ` <li class="list-group-item"><div class="progress"><div class="progress-bar progress-bar-striped" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" 
            aria-valuemin="0" aria-valuemax="100">${progress.toFixed(2)}%</div></div></li>`;

          } 
          
      }
    }
    html += `</ul></div><div class="card-footer text-muted"></div></div>`;
          
    document.getElementById("Badges in Progress").innerHTML += html ;

    badgesInProgress.appendChild(para);
  
      
  });

    
</script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://getbootstrap.com/docs/5.2/assets/css/docs.css" rel="stylesheet">


{% endblock %}